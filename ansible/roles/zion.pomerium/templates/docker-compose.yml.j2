#jinja2:lstrip_blocks: True
# {{ ansible_managed }}
---
version: '3.7'

services:
  pomerium:
    image: '{{ pomerium_image_version }}'
    container_name: pomerium
    restart: always
    environment:
      COOKIE_SECRET: '{{ pomerium_cookie_secret }}'
      IDP_CLIENT_SECRET: '{{ pomerium_idp_client_secret }}'
      IDP_CLIENT_ID: '{{ pomerium_idp_client_id }}'
    networks:
      - '{{ traefik_docker_network }}'
    volumes:
      - ./config.yaml:/pomerium/config.yaml:ro
      - ./server.key:/pomerium/server.key:ro
      - ./server.cer:/pomerium/server.cer:ro
    labels:
      traefik.enable: true
      traefik.pomerium.backend: pomerium
      traefik.pomerium.frontend.rule: 'Host: auth.{{ ansible_facts['domains'] }}'
      traefik.pomerium.port: 80
      {# # Forward the X-Forwarded-For header to Pomerium  #}
      {# traefik.pomerium.frontend.whiteList.XForwardedFor: true  #}
      {# Security headers #}
      traefik.pomerium.frontend.headers.frameDeny: true
      traefik.pomerium.frontend.headers.browserXSSFilter: true
      traefik.pomerium.frontend.headers.isDevelopment: false
      traefik.pomerium.frontend.headers.forceSTSHeader: true
      traefik.pomerium.frontend.headers.STSPreload: true
      traefik.pomerium.frontend.headers.STSSeconds: 31536000
      traefik.pomerium.frontend.headers.referrerPolicy: same-origin
      {# End security headers #}


networks:
  {{ traefik_docker_network }}:
    external: true
